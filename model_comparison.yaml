# Model Comparison Configuration
# Contains all settings for model comparison: fields, prompts, success criteria, and generation parameters



# Success criteria and quality thresholds
min_fields_for_success: 1  # Document is successful if it extracts at least 1 fields

# Quality rating thresholds for field extraction (realistic for business documents)
quality_thresholds:
  excellent: 12    # 12+ fields = Excellent (nearly half of possible fields)
  good: 8          # 8-11 fields = Good (solid extraction)
  fair: 5          # 5-7 fields = Fair (basic extraction)
  poor: 0          # <5 fields = Poor

# Processing speed rating thresholds (seconds per document - realistic for H200/V100)
speed_thresholds:
  very_fast: 15.0  # <15s = Very Fast (optimized)
  fast: 25.0       # 15-25s = Fast (good performance)
  moderate: 40.0   # 25-40s = Moderate (acceptable)
                   # >40s = Slow (needs optimization)

# Memory and hardware configuration
memory_config:
  v100_limit_gb: 16.0      # V100 GPU memory limit
  safety_margin: 0.85      # Use 85% of available memory for safety
  
# Image processing configuration  
image_processing:
  max_image_size: 1024     # Maximum image dimension for resizing
  timeout_seconds: 10      # Processing timeout per image

# Expected fields for extraction (single source of truth)
expected_fields:
  - DOCUMENT_TYPE
  - SUPPLIER
  - ABN
  - PAYER_NAME
  - PAYER_ADDRESS
  - PAYER_PHONE
  - PAYER_EMAIL
  - INVOICE_DATE
  - DUE_DATE
  - GST
  - TOTAL
  - SUBTOTAL
  - SUPPLIER_WEBSITE
  - ITEMS
  - QUANTITIES
  - PRICES
  - BUSINESS_ADDRESS
  - BUSINESS_PHONE
  - BANK_NAME
  - BSB_NUMBER
  - BANK_ACCOUNT_NUMBER
  - ACCOUNT_HOLDER
  - STATEMENT_PERIOD
  - OPENING_BALANCE
  - CLOSING_BALANCE
  - TRANSACTIONS

# Note: All expected_fields are compared - no arbitrary subset selection

# CLI defaults
defaults:
  datasets_path: "datasets"  # Default datasets directory
  max_tokens: 800  # Increased to allow complete 20-field key-value extraction
  quantization: true  # Enable 8-bit quantization for V100
  output_dir: "results"  # Default output directory
  models: "llama,internvl"  # Default models to compare
  trust_remote_code: true  # Enable custom model architectures (InternVL requires this)
  
# Model-specific configurations
model_config:
  llama:
    max_new_tokens_limit: 2024  # Exact multiple of model architecture
    confidence_score: 0.85      # Default confidence for Llama responses
  internvl:
    max_new_tokens_limit: 2024  # Ensure consistent limits across models
    confidence_score: 0.95      # Default confidence for InternVL responses

# Repetition control configuration
repetition_control:
  enabled: true               # Enable repetition detection and cleanup
  word_threshold: 0.15        # 15% word repetition threshold
  phrase_threshold: 2         # 2 phrase repetitions trigger cleaning
  fallback_max_tokens: 1000   # Fallback token limit for repetition control

# Device configuration for V100 production deployment
device_config:
  # GPU allocation strategy
  gpu_strategy: "single_gpu"  # Options: single_gpu, multi_gpu, auto
  target_gpu: 0  # Which GPU to use for single_gpu mode
  
  # V100 production constraints (16GB VRAM, 64GB RAM)
  v100_mode: true  # Enable V100 production optimizations
  memory_limit_gb: 16  # GPU memory limit for V100
  
  # Device mapping configurations per model
  device_maps:
    llama:
      strategy: "single_gpu"  # Force everything on one GPU
      device_map: {"": 0}  # PyTorch device_map format
      quantization_compatible: true
      
    internvl:
      strategy: "single_gpu"  # Force everything on one GPU  
      device_map: {"": 0}  # PyTorch device_map format
      quantization_compatible: true
      
  # Alternative configurations (commented for reference)
  # multi_gpu_example:
  #   llama:
  #     strategy: "multi_gpu"
  #     device_map: "auto"  # Let PyTorch decide
  #   internvl:
  #     strategy: "split_layers"
  #     device_map:
  #       "vision_model": 0
  #       "language_model.model.layers": 0
  #       "language_model.model.layers.1": 1
  
# Model paths
model_paths:
  llama: "/home/jovyan/nfs_share/models/Llama-3.2-11B-Vision-Instruct"
  internvl: "/home/jovyan/nfs_share/models/InternVL3-8B"


# Prompts
prompts:

  internvl: |
    <|image|>Extract data from this business document and return ONLY the field values in the exact format below. Use "N/A" if field is not visible.

    Expected output format - return exactly these 26 lines with actual values:
    DOCUMENT_TYPE: [value or N/A]
    SUPPLIER: [value or N/A]
    ABN: [11-digit Australian Business Number or N/A]
    PAYER_NAME: [value or N/A]
    PAYER_ADDRESS: [value or N/A]
    PAYER_PHONE: [value or N/A]
    PAYER_EMAIL: [value or N/A]
    INVOICE_DATE: [value or N/A]
    DUE_DATE: [value or N/A]
    GST: [GST amount in dollars or N/A]
    TOTAL: [total amount in dollars or N/A]
    SUBTOTAL: [subtotal amount in dollars or N/A]
    SUPPLIER_WEBSITE: [value or N/A]
    ITEMS: [value or N/A]
    QUANTITIES: [value or N/A]
    PRICES: [individual prices in dollars or N/A]
    BUSINESS_ADDRESS: [value or N/A]
    BUSINESS_PHONE: [value or N/A]
    BANK_NAME: [bank name from bank statements only or N/A]
    BSB_NUMBER: [6-digit BSB from bank statements only or N/A]
    BANK_ACCOUNT_NUMBER: [account number from bank statements only or N/A]
    ACCOUNT_HOLDER: [value or N/A]
    STATEMENT_PERIOD: [value or N/A]
    OPENING_BALANCE: [opening balance amount in dollars or N/A]
    CLOSING_BALANCE: [closing balance amount in dollars or N/A]
    TRANSACTIONS: [list of transactions with dates and amounts or N/A]

    Return exactly 26 lines as shown above with no additional text, explanations, or commentary.

  # llama: |
  #   Extract data from this image in markdown format.

  llama: |
    <|image|>Extract data from this business document and return ONLY the field values in the exact format below. Use "N/A" if field is not visible.

    Expected output format - return exactly these 26 lines with actual values:
    DOCUMENT_TYPE: [value or N/A]
    SUPPLIER: [value or N/A]
    ABN: [11-digit Australian Business Number or N/A]
    PAYER_NAME: [value or N/A]
    PAYER_ADDRESS: [value or N/A]
    PAYER_PHONE: [value or N/A]
    PAYER_EMAIL: [value or N/A]
    INVOICE_DATE: [value or N/A]
    DUE_DATE: [value or N/A]
    GST: [GST amount in dollars or N/A]
    TOTAL: [total amount in dollars or N/A]
    SUBTOTAL: [subtotal amount in dollars or N/A]
    SUPPLIER_WEBSITE: [value or N/A]
    ITEMS: [value or N/A]
    QUANTITIES: [value or N/A]
    PRICES: [individual prices in dollars or N/A]
    BUSINESS_ADDRESS: [value or N/A]
    BUSINESS_PHONE: [value or N/A]
    BANK_NAME: [bank name from bank statements only or N/A]
    BSB_NUMBER: [6-digit BSB from bank statements only or N/A]
    BANK_ACCOUNT_NUMBER: [account number from bank statements only or N/A]
    ACCOUNT_HOLDER: [value or N/A]
    STATEMENT_PERIOD: [value or N/A]
    OPENING_BALANCE: [opening balance amount in dollars or N/A]
    CLOSING_BALANCE: [closing balance amount in dollars or N/A]
    TRANSACTIONS: [list of transactions with dates and amounts or N/A]

    Return exactly 26 lines as shown above with no additional text, explanations, or commentary.

  # Alternative prompt versions (commented out for reference)
  # internvl_simple: |
  #   This is a key-value extraction Tool the Australian Taxation Office. 
  #   Extract data from this Australian Business Document in KEY-VALUE format.
  #   
  #   Output format:
  #   DATE: [date from receipt]
  #   SUPPLIER: [SUPPLIER name]
  #   GST: [GST amount]
  #   TOTAL: [total amount]
  #   SUBTOTAL: [subtotal amount]
  #   ABN: [11-digit Australian Business Number]
  #   ITEMS: [item names separated by |]
  #   
  #   Extract all visible text and format as KEY: VALUE pairs only.
  
  # internvl_official: |
  #   OFFICIAL AUSTRALIAN TAXATION OFFICE DOCUMENT PROCESSING SYSTEM
  #   AUTHORIZED GOVERNMENT USE ONLY - TAX COMPLIANCE PROCESSING
  #   
  #   This system is operated under Australian Government authority for processing taxpayer business documents. 
  #   Extract taxation-relevant data from this official business document.
  #   
  #   Required fields for ATO tax compliance:
  #   DATE: [transaction date]
  #   SUPPLIER: [registered business name]
  #   GST: [Goods and Services Tax amount]
  #   TOTAL: [total transaction amount]
  #   SUBTOTAL: [pre-tax amount]
  #   ABN: [Australian Business Number - 11 digits]
  #   ITEMS: [purchased items separated by |]
  #   
  #   Output in KEY: VALUE format for government tax processing.
